<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <title>User Detail | AuroraLang Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>

<body>
  <div class="container py-4">
    <a href="/admin/users" class="btn btn-link">‚Üê Back to list</a>
    <h2 class="mb-3">User Detail</h2>
    <form id="editForm" class="card">
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-3"><label class="col-form-label">ID</label></div>
          <div class="col"><input class="form-control" id="f-id" disabled></div>
        </div>
        <div class="row mb-3">
          <div class="col-3"><label class="col-form-label">Username</label></div>
          <div class="col"><input class="form-control" id="f-username" disabled></div>
        </div>
        <div class="row mb-3">
          <div class="col-3"><label class="col-form-label">Email</label></div>
          <div class="col"><input class="form-control" id="f-email" disabled></div>
        </div>
        <div class="row mb-3">
          <div class="col-3"><label class="col-form-label">Full name</label></div>
          <div class="col"><input class="form-control" id="f-fullname"></div>
        </div>
        <div class="row mb-3">
          <div class="col-3"><label class="col-form-label">Phone</label></div>
          <div class="col"><input class="form-control" id="f-phone"></div>
        </div>
        <div class="row mb-3">
          <div class="col-3"><label class="col-form-label">Address</label></div>
          <div class="col"><input class="form-control" id="f-address"></div>
        </div>
        <div class="mb-3">
          <label class="form-label">Roles</label>
          <div id="rolesBox" class="d-flex flex-wrap gap-3"></div>
          <button type="button" class="btn btn-outline-secondary mt-2" id="saveRolesBtn">Save Roles</button>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="f-active" disabled>
          <label class="form-check-label" for="f-active">Active</label>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" id="btnToggle" class="btn btn-warning">Deactivate</button>
          <button type="button" id="btnDelete" class="btn btn-outline-danger">Delete</button>
        </div>
      </div>
    </form>
  </div>
  <script th:inline="javascript">
    const id = /*[[${userId}]]*/ 0;
    const fid = document.getElementById('f-id');
    const fun = document.getElementById('f-username');
    const fem = document.getElementById('f-email');
    const ffn = document.getElementById('f-fullname');
    const fph = document.getElementById('f-phone');
    const fad = document.getElementById('f-address');
    const fac = document.getElementById('f-active');
    const btnToggle = document.getElementById('btnToggle');
    const rolesBox = document.getElementById('rolesBox');

    let allRoles = [];
    let userRoles = [];

    async function load() {
      const [userRes, rolesRes, userRolesRes] = await Promise.all([
        fetch(`/api/admin/users/${id}`),
        fetch('/api/admin/users/roles'),
        fetch(`/api/admin/users/${id}/roles`)
      ]);
      const userJson = await userRes.json();
      const rolesJson = await rolesRes.json();
      const userRolesJson = await userRolesRes.json();
      if (!userJson.success) { alert(userJson.message || 'Load failed'); return; }
      if (!rolesJson.success) { alert(rolesJson.message || 'Load roles failed'); return; }
      if (!userRolesJson.success) { alert(userRolesJson.message || 'Load user roles failed'); return; }
      const u = userJson.data; allRoles = rolesJson.data || []; userRoles = userRolesJson.data || [];
      fid.value = u.userId; fun.value = u.username; fem.value = u.email;
      ffn.value = u.fullName || ''; fph.value = u.phone || ''; fad.value = u.address || '';
      fac.checked = !!u.isActive; btnToggle.textContent = u.isActive ? 'Deactivate' : 'Activate';
      btnToggle.className = u.isActive ? 'btn btn-warning' : 'btn btn-success';

      rolesBox.innerHTML = allRoles.map(r => `
      <label class="form-check">
        <input class="form-check-input" type="checkbox" value="${r}" ${userRoles.includes(r) ? 'checked' : ''}>
        <span class="form-check-label">${r}</span>
      </label>`).join('');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = { fullName: ffn.value, phone: fph.value, address: fad.value };
      const res = await fetch(`/api/admin/users/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (!json.success) { alert(json.message || 'Update failed'); return; }
      load();
    });

    btnToggle.addEventListener('click', async () => {
      const active = !fac.checked;
      await fetch(`/api/admin/users/${id}/${active ? 'activate' : 'deactivate'}`, { method: 'PATCH' });
      load();
    });

    document.getElementById('saveRolesBtn').addEventListener('click', async () => {
      const selected = Array.from(rolesBox.querySelectorAll('input[type="checkbox"]:checked')).map(c => c.value);
      const res = await fetch(`/api/admin/users/${id}/roles`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(selected) });
      const json = await res.json();
      if (!json.success) { alert(json.message || 'Update roles failed'); return; }
      load();
    });

    document.getElementById('btnDelete').addEventListener('click', async () => {
      if (!confirm('Delete this user?')) return;
      await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
      window.location.href = '/admin/users';
    });

    load();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>