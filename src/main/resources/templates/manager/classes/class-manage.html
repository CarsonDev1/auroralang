<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Detail - AuroraLang</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 0.75rem 1rem;
      margin: 0.25rem 0;
      border-radius: 0.5rem;
      transition: all 0.3s;
    }

    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      color: white;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .main-content {
      background-color: #f8f9fa;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }

    .form-control:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .status-badge {
      padding: 0.375rem 0.75rem;
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-planned {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .status-ongoing {
      background-color: #e8f5e8;
      color: #388e3c;
    }

    .status-completed {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .status-cancelled {
      background-color: #ffebee;
      color: #d32f2f;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4 class="text-white">AuroraLang</h4>
            <p class="text-white-50 mb-0">Manager Portal</p>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="/manager/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i> Dashboard </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/manager/classes/class-list">
                <i class="fas fa-chalkboard-teacher me-2"></i> Classes </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/manager/students/student-list">
                <i class="fas fa-user-graduate me-2"></i> Students </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/auth/logout">
                <i class="fas fa-sign-out-alt me-2"></i> Logout </a>
            </li>
          </ul>
        </div>
      </nav>
      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Class Detail</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                <i class="fas fa-arrow-left me-1"></i> Back </button>
            </div>
          </div>
        </div>
        <!-- Class Detail Form -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                  <i class="fas fa-chalkboard-teacher me-2"></i> Class Information
                </h5>
              </div>
              <div class="card-body">
                <form id="classForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="classCode" class="form-label">Class Code *</label>
                        <input type="text" class="form-control" id="classCode" name="classCode" required readonly>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="className" class="form-label">Class Name *</label>
                        <input type="text" class="form-control" id="className" name="className" required>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="courseId" class="form-label">Course *</label>
                        <select class="form-select" id="courseId" name="courseId" required>
                          <option value="">Select Course</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="teacherId" class="form-label">Teacher *</label>
                        <select class="form-select" id="teacherId" name="teacherId" required>
                          <option value="">Select Teacher</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" name="startDate">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" name="endDate">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="maxStudents" class="form-label">Max Students</label>
                        <input type="number" class="form-control" id="maxStudents" name="maxStudents" min="1">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                          <option value="PLANNED">Planned</option>
                          <option value="ONGOING">Ongoing</option>
                          <option value="COMPLETED">Completed</option>
                          <option value="CANCELLED">Cancelled</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label class="form-label">Visibility</label>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="isPublic" name="isPublic">
                          <label class="form-check-label" for="isPublic"> Public Class </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="scheduleInfo" class="form-label">Schedule Info</label>
                        <textarea class="form-control" id="scheduleInfo" name="scheduleInfo" rows="2"
                          placeholder="e.g., Mon/Wed/Fri 9:00-11:00"></textarea>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="roomInfo" class="form-label">Room Info</label>
                        <input type="text" class="form-control" id="roomInfo" name="roomInfo"
                          placeholder="e.g., Room A101">
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                      <i class="fas fa-times me-1"></i> Cancel </button>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save me-1"></i> Update Class </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- Class Statistics -->
        <div class="row mt-4">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <i class="fas fa-users fa-2x text-primary mb-2"></i>
                <h5 class="card-title">Current Students</h5>
                <h3 class="text-primary" id="currentStudents">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                <h5 class="card-title">Max Students</h5>
                <h3 class="text-success" id="maxStudentsDisplay">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                <h5 class="card-title">Capacity</h5>
                <h3 class="text-info" id="capacityPercentage">0%</h3>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let classId = null;

    document.addEventListener('DOMContentLoaded', function () {
      // Get class ID from URL
      const pathParts = window.location.pathname.split('/');
      classId = pathParts[pathParts.length - 1];

      if (classId && classId !== 'class-manage') {
        loadClassData();
      }

      loadCourses();
      loadTeachers();
    });

    async function loadClassData() {
      try {
        const response = await fetch(`/api/classes/${classId}`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const result = await response.json();
          const classData = result.data;

          // Populate form
          document.getElementById('classCode').value = classData.classCode || '';
          document.getElementById('className').value = classData.className || '';
          document.getElementById('description').value = classData.description || '';
          document.getElementById('startDate').value = classData.startDate || '';
          document.getElementById('endDate').value = classData.endDate || '';
          document.getElementById('maxStudents').value = classData.maxStudents || '';
          document.getElementById('scheduleInfo').value = classData.scheduleInfo || '';
          document.getElementById('roomInfo').value = classData.roomInfo || '';
          document.getElementById('status').value = classData.status || 'PLANNED';
          document.getElementById('isPublic').checked = classData.isPublic || false;

          // Set selected course and teacher after loading options
          setTimeout(() => {
            if (classData.courseId) {
              document.getElementById('courseId').value = classData.courseId;
            }
            if (classData.teacherId) {
              document.getElementById('teacherId').value = classData.teacherId;
            }
          }, 500);

          // Update statistics
          document.getElementById('currentStudents').textContent = classData.currentStudents || 0;
          document.getElementById('maxStudentsDisplay').textContent = classData.maxStudents || 0;

          const capacity = classData.maxStudents > 0 ?
            Math.round((classData.currentStudents / classData.maxStudents) * 100) : 0;
          document.getElementById('capacityPercentage').textContent = capacity + '%';

        } else {
          console.error('Failed to load class data');
          alert('Failed to load class data');
        }
      } catch (error) {
        console.error('Error loading class data:', error);
        alert('Error loading class data');
      }
    }

    async function loadCourses() {
      try {
        const response = await fetch(new URL('/api/select/courses', window.location.origin), {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const result = await response.json();
          const courseSelect = document.getElementById('courseId');

          result.data.forEach(course => {
            const option = document.createElement('option');
            option.value = course.id;
            option.textContent = course.label;
            courseSelect.appendChild(option);
          });
        } else {
          console.error('Failed to load courses');
        }
      } catch (error) {
        console.error('Error loading courses:', error);
      }
    }

    async function loadTeachers() {
      try {
        const response = await fetch(new URL('/api/select/teachers', window.location.origin), {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const result = await response.json();
          const teacherSelect = document.getElementById('teacherId');

          result.data.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = teacher.label;
            teacherSelect.appendChild(option);
          });
        } else {
          console.error('Failed to load teachers');
        }
      } catch (error) {
        console.error('Error loading teachers:', error);
      }
    }

    document.getElementById('classForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = {
        className: formData.get('className'),
        description: formData.get('description') || null,
        courseId: formData.get('courseId') ? parseInt(formData.get('courseId')) : null,
        teacherId: formData.get('teacherId') ? parseInt(formData.get('teacherId')) : null,
        startDate: formData.get('startDate') || null,
        endDate: formData.get('endDate') || null,
        maxStudents: formData.get('maxStudents') ? parseInt(formData.get('maxStudents')) : null,
        scheduleInfo: formData.get('scheduleInfo') || null,
        roomInfo: formData.get('roomInfo') || null,
        status: formData.get('status'),
        isPublic: formData.has('isPublic')
      };

      try {
        const response = await fetch(`/api/classes/${classId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
          alert('Class updated successfully!');
          window.location.href = '/manager/classes/class-list';
        } else {
          alert('Error: ' + (result.message || 'Failed to update class'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while updating the class');
      }
    });
  </script>
</body>

</html>