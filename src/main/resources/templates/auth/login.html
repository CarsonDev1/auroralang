<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8">
  <title>Login - AuroraLang</title>
  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f5f5;
    }

    .login-box {
      max-width: 430px;
      margin: 80px auto;
      background: white;
      padding: 25px 35px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
    }

    .password-toggle {
      cursor: pointer;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
    }

    .invalid-feedback {
      display: block;
    }
  </style>
</head>

<body>
  <div class="login-box">
    <h3 class="text-center mb-4">Welcome Back</h3>
    <!-- Alert l·ªói t·ªïng -->
    <div id="errorAlert" class="alert alert-danger d-none"></div>
    <form id="loginForm" novalidate>
      <!-- Username or Email -->
      <div class="mb-3">
        <label for="usernameOrEmail" class="form-label">Username or Email</label>
        <input type="text" class="form-control" id="usernameOrEmail" required>
        <div id="userError" class="invalid-feedback"></div>
      </div>
      <!-- Password -->
      <div class="mb-3 position-relative">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" required>
        <i id="togglePassword" class="bi bi-eye password-toggle"></i>
        <div id="passError" class="invalid-feedback"></div>
      </div>
      <button type="submit" class="btn btn-primary w-100">Login</button>
      <div class="text-center mt-3">
        <small>Don't have an account? <a th:href="@{/auth/register}">Create one</a></small>
      </div>
    </form>
  </div>
  <!-- JS Validation -->
  <script>
    const usernameOrEmailInput = document.getElementById("usernameOrEmail");
    const passwordInput = document.getElementById("password");
    const errorAlert = document.getElementById("errorAlert");
    const userError = document.getElementById("userError");
    const passError = document.getElementById("passError");

    // üëÅ Toggle password visibility
    document.getElementById("togglePassword").addEventListener("click", function () {
      const type = passwordInput.type === "password" ? "text" : "password";
      passwordInput.type = type;
      this.classList.toggle("bi-eye-slash");
    });

    // ‚öôÔ∏è Validate input logic
    function validateLoginInputs() {
      let isValid = true;
      userError.textContent = "";
      passError.textContent = "";
      errorAlert.classList.add("d-none");

      const usernameOrEmail = usernameOrEmailInput.value.trim();
      const password = passwordInput.value.trim();

      // Validate username or email
      if (usernameOrEmail.length === 0) {
        userError.textContent = "Please enter your username or email.";
        isValid = false;
      } else if (usernameOrEmail.length < 3 || usernameOrEmail.length > 40) {
        userError.textContent = "Username or email must be 3‚Äì40 characters.";
        isValid = false;
      } else if (usernameOrEmail.includes("@")) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(usernameOrEmail)) {
          userError.textContent = "Invalid email format.";
          isValid = false;
        }
      }

      // Validate password
      if (password.length === 0) {
        passError.textContent = "Please enter your password.";
        isValid = false;
      } else if (password.length < 8 || password.length > 50) {
        passError.textContent = "Password must be 8‚Äì50 characters.";
        isValid = false;
      }

      return isValid;
    }

    // üöÄ Handle login form submit
    document.getElementById("loginForm").addEventListener("submit", async function (event) {
      event.preventDefault();

      if (!validateLoginInputs()) return;

      const payload = {
        usernameOrEmail: usernameOrEmailInput.value.trim(),
        password: passwordInput.value
      };

      try {
        const response = await fetch("/auth/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!result.success) {
          showError(result.message || "Login failed. Please check your credentials.");
          return;
        }

        // ‚úÖ L∆∞u JWT token
        localStorage.setItem("token", result.data.token);

        // ‚úÖ Redirect theo role
        const roles = result.data.roles || [];
        if (roles.includes("ROLE_ADMIN")) window.location.href = "/admin/dashboard";
        else if (roles.includes("ROLE_MANAGER")) window.location.href = "/manager/dashboard";
        else if (roles.includes("ROLE_TEACHER")) window.location.href = "/teacher/dashboard";
        else if (roles.includes("ROLE_EXPERT")) window.location.href = "/expert/dashboard";
        else window.location.href = "/student/dashboard";

      } catch (error) {
        showError("Internal server error. Please try again later.");
      }
    });

    // ‚ö†Ô∏è Hi·ªÉn th·ªã l·ªói t·ªïng
    function showError(message) {
      errorAlert.innerText = message;
      errorAlert.classList.remove("d-none");
    }
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>