<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Mode | Student</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    .study-card {
      min-height: 300px;
      cursor: pointer;
    }

    .study-content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 250px;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>Study Mode</h3>
      <a href="/student/flashcards" class="btn btn-outline-secondary">Back to Library</a>
    </div>
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <div class="card study-card" id="studyCard" onclick="flip()">
          <div class="card-body study-content">
            <div class="text-center">
              <h2 id="cardText">Click "Start Study" to begin</h2>
              <div id="cardPronunciation" class="text-muted mt-2"></div>
              <div id="cardImage" class="mt-3"></div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
              <span id="progress">0 / 0</span>
            </div>
            <div>
              <button class="btn btn-success" id="startBtn" onclick="startStudy()">Start Study</button>
              <button class="btn btn-primary d-none" id="nextBtn" onclick="nextCard()">Next</button>
              <button class="btn btn-warning d-none" id="againBtn" onclick="againCard()">Again</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let flashcards = [];
    let currentIndex = 0;
    let isFlipped = false;
    let studyStarted = false;

    async function loadFlashcards() {
      const res = await fetch('/api/flashcards/my-flashcards?size=50', { credentials: 'include' });
      const json = await res.json();
      if (json.success) {
        flashcards = json.data.content || [];
      }
    }

    function startStudy() {
      if (flashcards.length === 0) {
        alert('No flashcards available');
        return;
      }
      studyStarted = true;
      currentIndex = 0;
      document.getElementById('startBtn').classList.add('d-none');
      showCard();
    }

    function showCard() {
      if (currentIndex >= flashcards.length) {
        document.getElementById('cardText').textContent = 'Study completed!';
        document.getElementById('cardPronunciation').textContent = '';
        document.getElementById('cardImage').innerHTML = '';
        document.getElementById('nextBtn').classList.add('d-none');
        document.getElementById('againBtn').classList.add('d-none');
        document.getElementById('startBtn').classList.remove('d-none');
        document.getElementById('startBtn').textContent = 'Study Again';
        studyStarted = false;
        return;
      }

      const card = flashcards[currentIndex];
      document.getElementById('cardText').textContent = card.frontText || '';
      document.getElementById('cardPronunciation').textContent = card.pronunciation || '';
      const img = document.getElementById('cardImage');
      if (card.frontImageUrl) {
        img.innerHTML = `<img src="${card.frontImageUrl}" class="img-fluid" style="max-height:100px" alt="Front">`;
      } else {
        img.innerHTML = '';
      }

      document.getElementById('progress').textContent = `${currentIndex + 1} / ${flashcards.length}`;
      document.getElementById('nextBtn').classList.add('d-none');
      document.getElementById('againBtn').classList.add('d-none');
      isFlipped = false;
    }

    function flip() {
      if (!studyStarted || currentIndex >= flashcards.length) return;

      const card = flashcards[currentIndex];
      if (!isFlipped) {
        document.getElementById('cardText').textContent = card.backText || '';
        document.getElementById('cardPronunciation').textContent = '';
        const img = document.getElementById('cardImage');
        if (card.backImageUrl) {
          img.innerHTML = `<img src="${card.backImageUrl}" class="img-fluid" style="max-height:100px" alt="Back">`;
        } else {
          img.innerHTML = '';
        }
        document.getElementById('nextBtn').classList.remove('d-none');
        document.getElementById('againBtn').classList.remove('d-none');
        isFlipped = true;
      }
    }

    function nextCard() {
      currentIndex++;
      showCard();
    }

    function againCard() {
      // Add current card to end for review
      flashcards.push(flashcards[currentIndex]);
      currentIndex++;
      showCard();
    }

    document.addEventListener('DOMContentLoaded', loadFlashcards);
  </script>
</body>

</html>