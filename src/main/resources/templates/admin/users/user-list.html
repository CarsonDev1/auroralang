<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <title>Users | AuroraLang Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>

<body>
  <div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Users</h2>
      <div class="d-flex gap-2">
        <a class="btn btn-success" href="/admin/users/new">+ New User</a>
        <input id="q" class="form-control" placeholder="Search name/email/username" style="min-width:260px" />
        <button class="btn btn-outline-secondary" onclick="load(0)">Search</button>
      </div>
    </div>
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Full name</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <nav>
      <ul class="pagination" id="pager"></ul>
    </nav>
  </div>
  <script>
    async function load(page = 0) {
      const q = document.getElementById('q').value.trim();
      const url = new URL('/api/admin/users', window.location.origin);
      url.searchParams.set('page', page);
      url.searchParams.set('size', 10);
      if (q) url.searchParams.set('q', q);
      const res = await fetch(url);
      const json = await res.json();
      if (!json.success) { alert(json.message || 'Load failed'); return; }
      const p = json.data;
      document.getElementById('tbody').innerHTML = p.content.map(u => `
      <tr>
        <td>${u.userId}</td>
        <td>${u.username}</td>
        <td>${u.email}</td>
        <td>${u.fullName || ''}</td>
        <td>${u.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
        <td>${(u.createdAt || '').toString().replace('T', ' ').substring(0, 19)}</td>
        <td>
          <a class="btn btn-sm btn-outline-primary" href="/admin/users/${u.userId}">View</a>
          <button class="btn btn-sm ${u.isActive ? 'btn-warning' : 'btn-success'}" onclick="toggle(${u.userId}, ${!u.isActive})">${u.isActive ? 'Deactivate' : 'Activate'}</button>
          <button class="btn btn-sm btn-outline-danger" onclick="del(${u.userId})">Delete</button>
        </td>
      </tr>`).join('');
      renderPager(p);
    }
    function renderPager(p) {
      const ul = document.getElementById('pager');
      ul.innerHTML = '';
      for (let i = 0; i < p.totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === p.page ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
        li.addEventListener('click', (e) => { e.preventDefault(); load(i) });
        ul.appendChild(li);
      }
    }
    async function toggle(id, active) {
      await fetch(`/api/admin/users/${id}/${active ? 'activate' : 'deactivate'}`, { method: 'PATCH' });
      load(0);
    }
    async function del(id) {
      if (!confirm('Delete this user?')) return;
      await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
      load(0);
    }
    load();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>